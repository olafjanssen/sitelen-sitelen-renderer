<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta name="viewport" content="width=480, initial-scale=1">
    <meta charset="utf-8">
    <link rel="icon" href="data:,">
    <script type="module" src="../../sitelen-wasm/pkg/sitelen_wasm.js"></script>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
        }

        h1 {
            font-size: 1.5em;
            margin: 1em auto;
            display: block;
        }

        .wordmark {
            color: red;
        }

        #sitelen {
            border-radius: 1em;
            margin: 0 auto;
            width: 20em;
        }

        #sitelen svg {
            width: 100%;
        }

        #sitelen input {
            margin: 1em auto;
            display: block;
            width: 50%;
        }

        #sitelen a {
            text-align: center;
            display: block;
            margin: 1em 0;
            width: 100%;
        }

        #tokiInput {
            margin: 2em auto;
            display: block;
            font-size: 1em;
            width: 20em;
        }

        #known-issues a {
            display: block;
        }

        .text-container {
            text-align: left;
            margin: 0 auto;
            width: 30em;
        }

        .download-btn {
            margin: 1em auto;
            padding: 0.5em 1em;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            display: block;
        }

        .download-btn:hover {
            background: #45a049;
        }

        .error {
            color: red;
            margin: 1em 0;
        }

        .loading {
            color: #666;
            margin: 1em 0;
        }

        #ratioSlider {
            width: 100%;
            margin: 1em 0;
        }

        .slider-container {
            margin: 1em 0;
        }
    </style>
</head>

<body>

    <div class="text-container">
        <h1>Live Toki Pona <span class="wordmark">Sitelen Sitelen Renderer</span> (WASM)</h1>
        <p>I created <span class="wordmark">Sitelen Sitelen Renderer</span> because I am fascinated by combining the
            artificial
            language Toki Pona with the non-linear writing style 'Sitelen Sitelen' by Jonathan Gabel. Unlike other work
            with
            Sitelen Sitelen I want the writings to be generated by the computer. My <a
                href="http://nullelement.org/2015/05/living-toki-pona-using-flexbox-layout-and-sitelen-sitelen/">first
                attempt</a> was in the beginning of 2015 when I experimented with CSS Flexbox using SVG for the Glyphs.
            The
            algorithm was limited and doomed so in October 2015 I started anew, and set out to create SVG-only sitelen
            sitelen that can be exported and reused.
            <p>
                <p>On this page you can type (proper) Toki Pona. The text is parsed
                    into structures that can be rendered in the style of Sitelen Sitelen. By using the slider you
                    can choose the form that you like. This version uses WebAssembly for fast rendering. You can download the self-contained SVG which you can then use wherever.</p>
                <p>Mind that this project is very much in alpha, many language constructs are not implemented yet. If
                    you find them
                    you can add them to the issue list, see my <a
                        href="https://github.com/olafjanssen/sitelen-sitelen-renderer/">GitHub
                        repo</a>. Also check out the Toki Pona <a href="../proverbs/proverbs.html"
                        target="_blank">proverbs</a> from
                    Sonja's book generated by <span class="wordmark">Sitelen Sitelen Renderer</span>.</p>

                <p>~ Cheers! <a href="https://nl.linkedin.com/in/otajanssen" target="_blank">Olaf Janssen</a></p>

                <input type="text" id="tokiInput" placeholder="write toki pona here">

                <div id="sliderContainer" class="slider-container" style="display: none; width: 200px; margin: 1em auto;">
                    <input type="range" id="ratioSlider" min="0" max="0" step="1" value="0">
                </div>

                <div id="sitelen">
                    <p class="loading">Loading WASM module...</p>
                </div>

                <button id="downloadBtn" class="download-btn" style="display: none;">Download as SVG</button>

                <h2>Known issues (<a href="https://github.com/olafjanssen/sitelen-sitelen-renderer/issues">GitHub</a>)
                </h2>
                <ul id="known-issues">

                </ul>

                <h2>Attribution</h2>
                <p>This live sitelen sitelen sandbox web app is made possible by the great work done work before me.</p>
                <p><a href="http://tokipona.org/" target="_blank">Toki Pona</a> is an artificial language invented in
                    2001 by Sonja
                    Lang as an
                    attempt to understand the meaning of
                    life in 120 words. In my own search, I am convinced this language should not be used to translate
                    large bodies
                    of text or as an actual means of communication but as a personal tool for soul searching.</p>
                <p><a href="http://www.jonathangabel.com/archive/2012/projects_t47.html" target="_blank">Sitelen Sitelen
                        or Sitelen
                        Suwi</a> is a
                    project created by Jonathan Gabel in 2012 who created a non-linear writing
                    style for Toki Pona inspired by Mayan script. I try to keep the algorithm behind the <span
                        class="wordmark">sitelen sitelen renderer</span> in the spirit of Jonathan's project and allow
                    for the
                    different ways of drawing the sitelen sitelen.</p>
                <p>The <span class="wordmark">sitelen sitelen renderer</span> formerly parsed text based on the <a
                        href="http://www2.hawaii.edu/~chin/661F12/projects.html" target="_blank">context-free grammar by
                        Zach
                        Tomaszewski</a> in 2012. I have discontinued to improve this grammar now that I find it to give
                    wrong parses in
                    more and more
                    sentences. I have replaced it by a simpler algorithm tailored to sitelen sitelen requirements.</p>
                <p>The <a href="http://forums.tokipona.org/viewtopic.php?f=7&p=13786#p13786" target="_blank">vectorized
                        glyphs</a>
                    are based on the
                    excellent work by jan Same. To make my SVGs scalable I sadly had to get rid of the non-uniform
                    stroke widths.
                    Also I have slightly different ideas about how to use the containers so I took the liberty of
                    slightly altering
                    some glyphs.</p>
    </div>

    <script type="module">
        import init, { render_svg, get_layout_ratios } from '../../sitelen-wasm/pkg/sitelen_wasm.js';

        let initialized = false;
        let currentSvg = null;
        let layoutRatios = [];
        let currentRatioIndex = 0;

        async function ensureInit() {
            if (!initialized) {
                try {
                    await init();
                    initialized = true;
                    document.getElementById('sitelen').innerHTML = '';
                    console.log('WASM module initialized');
                } catch (error) {
                    document.getElementById('sitelen').innerHTML = 
                        `<p class="error">Failed to initialize WASM module: ${error.message}</p>`;
                    console.error('Initialization error:', error);
                    throw error;
                }
            }
        }

        async function updateLayoutOptions(text) {
            if (!text.trim()) {
                layoutRatios = [];
                return;
            }

            try {
                const ratiosJson = get_layout_ratios(text);
                layoutRatios = JSON.parse(ratiosJson);
                
                const slider = document.getElementById('ratioSlider');
                const sliderContainer = document.getElementById('sliderContainer');
                
                if (layoutRatios.length > 1) {
                    slider.max = layoutRatios.length - 1;
                    sliderContainer.style.display = 'block';
                    
                    // Find initial option closest to 0.8
                    let initialOption = [0, 100];
                    layoutRatios.forEach((ratio, index) => {
                        const dif = Math.abs(ratio - 0.8);
                        if (dif < initialOption[1]) {
                            initialOption = [index, dif];
                        }
                    });
                    currentRatioIndex = initialOption[0];
                    slider.value = initialOption[0];
                } else {
                    sliderContainer.style.display = 'none';
                    currentRatioIndex = 0;
                }
            } catch (error) {
                console.error('Failed to get layout options:', error);
                layoutRatios = [];
            }
        }

        async function renderInput() {
            if (!initialized) {
                await ensureInit();
            }

            const input = document.getElementById('tokiInput');
            const text = input.value;
            const output = document.getElementById('sitelen');
            const downloadBtn = document.getElementById('downloadBtn');

            if (!text.trim()) {
                output.innerHTML = '<p>Please enter some Toki Pona text.</p>';
                downloadBtn.style.display = 'none';
                document.getElementById('sliderContainer').style.display = 'none';
                return;
            }

            // Update layout options
            await updateLayoutOptions(text);

            // Render with current ratio
            await renderWithCurrentRatio(text);
        }

        async function renderWithCurrentRatio(text) {
            const output = document.getElementById('sitelen');
            const downloadBtn = document.getElementById('downloadBtn');

            if (layoutRatios.length === 0) {
                try {
                    const svgContent = render_svg(text);
                    output.innerHTML = svgContent;
                    currentSvg = svgContent;
                    downloadBtn.style.display = 'block';
                } catch (error) {
                    const errorMsg = error.message || String(error);
                    output.innerHTML = `<p class="error">Error rendering: ${errorMsg}</p>`;
                    downloadBtn.style.display = 'none';
                    console.error('Rendering error:', error);
                }
            } else {
                try {
                    const ratio = layoutRatios[currentRatioIndex];
                    const svgContent = render_svg(text, ratio);
                    output.innerHTML = svgContent;
                    currentSvg = svgContent;
                    downloadBtn.style.display = 'block';
                } catch (error) {
                    const errorMsg = error.message || String(error);
                    output.innerHTML = `<p class="error">Error rendering: ${errorMsg}</p>`;
                    downloadBtn.style.display = 'none';
                    console.error('Rendering error:', error);
                }
            }
        }

        function downloadSvg() {
            if (!currentSvg) return;

            const blob = new Blob([currentSvg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sitelen-sitelen.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on page load
        window.addEventListener('load', async function () {
            await ensureInit();

            const input = document.getElementById('tokiInput');
            const slider = document.getElementById('ratioSlider');
            
            input.addEventListener('input', renderInput);
            
            slider.addEventListener('input', async function() {
                currentRatioIndex = parseInt(slider.value);
                const text = input.value;
                if (text.trim()) {
                    await renderWithCurrentRatio(text);
                }
            });
            
            input.value = 'pilin pona li pana e sijelo pona.';
            renderInput();

            document.getElementById('downloadBtn').addEventListener('click', downloadSvg);
        });
    </script>

    <script>
        function loadIssues() {
            var xhr = new XMLHttpRequest;
            xhr.open('get', 'https://api.github.com/repos/olafjanssen/sitelen-sitelen-renderer/issues', true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState != 4) return;
                try {
                    var data = JSON.parse(xhr.response);
                    data.forEach(function (issue) {
                        var listItem = document.createElement('li'),
                            link = document.createElement('a');
                        link.setAttribute('href', issue.html_url);
                        link.setAttribute('target', '_blank');
                        link.appendChild(document.createTextNode(issue.title));
                        listItem.appendChild(link);
                        document.getElementById('known-issues').appendChild(listItem);
                    });
                } catch (e) {
                    console.error('Failed to load issues:', e);
                }
            };
            xhr.send();
        }

        loadIssues();
    </script>

</body>

</html>

