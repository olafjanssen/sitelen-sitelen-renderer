<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sitelen Sitelen Editor</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }

        .main-header {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .main-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            color: #333;
        }

        .main-header .wordmark {
            color: #e63946;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .scale-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f8f8;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .scale-btn {
            background: white;
            border: 1px solid #d0d0d0;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
            transition: all 0.2s;
            user-select: none;
        }

        .scale-btn:hover {
            background: #f0f0f0;
            border-color: #b0b0b0;
        }

        .scale-btn:active {
            background: #e0e0e0;
        }

        .scale-value {
            min-width: 40px;
            text-align: center;
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .info-btn {
            background: #2196f3;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .info-btn:hover {
            background: #1976d2;
            transform: scale(1.05);
        }

        .info-btn:active {
            transform: scale(0.95);
        }

        .editor-container {
            display: flex;
            height: calc(100vh - 65px);
            width: 100%;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-right: 1px solid #e0e0e0;
        }

        .preview-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            overflow: hidden;
        }

        .pane-header {
            padding: 12px 16px;
            background: #f8f8f8;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-textarea {
            flex: 1;
            width: 100%;
            padding: 20px;
            border: none;
            outline: none;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            background: white;
            color: #333;
        }

        .editor-textarea::placeholder {
            color: #999;
        }

        .preview-content {
            flex: 1;
            padding: 20px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .sentences-container {
            column-width: 100px;
            column-gap: 20px;
            column-fill: auto;
            height: 100%;
            transition: column-width 0.2s ease;
        }

        .sentence-item {
            break-inside: avoid;
            margin-bottom: 20px;
            display: block;
        }

        .sentence-item svg {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Direct SVGs returned from WASM without wrappers */
        .sentences-container svg {
            width: 100%;
            height: auto;
            display: block;
            break-inside: avoid;
            margin-bottom: 20px;
        }

        .preview-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 14px;
        }

        .preview-error {
            color: #d32f2f;
            padding: 16px;
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            margin: 16px;
            border-radius: 4px;
        }

        .preview-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 14px;
        }

        .resizer {
            width: 4px;
            background: #e0e0e0;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resizer:hover {
            background: #bdbdbd;
        }

        .resizer.active {
            background: #2196f3;
        }

        /* Scrollbar styling */
        .preview-content::-webkit-scrollbar {
            height: 8px;
        }

        .preview-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .preview-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .preview-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .editor-textarea::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .editor-textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .editor-textarea::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .editor-textarea::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Info Modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .info-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .info-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            margin: 20px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .info-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0f0f0;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            transition: all 0.2s;
        }

        .info-modal-close:hover {
            background: #e0e0e0;
        }

        .info-modal h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: #333;
        }

        .info-modal h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            color: #333;
        }

        .info-modal p {
            margin: 0 0 1rem 0;
            color: #666;
            line-height: 1.6;
        }

        .info-modal ul {
            margin: 0 0 1rem 0;
            padding-left: 1.5rem;
        }

        .info-modal li {
            margin-bottom: 0.75rem;
            color: #666;
            line-height: 1.6;
        }

        .info-modal code {
            background: #f8f8f8;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .info-modal a {
            color: #2196f3;
            text-decoration: none;
        }

        .info-modal a:hover {
            text-decoration: underline;
        }

        .info-modal .wordmark {
            color: #e63946;
        }

        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }

            .editor-pane {
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }

            .preview-pane {
                height: 50vh;
            }

            .resizer {
                width: 100%;
                height: 4px;
                cursor: row-resize;
            }

            .main-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>Sitelen Sitelen Renderer <span class="wordmark">Live Editor</span></h1>
        <div class="header-controls">
            <div class="scale-controls">
                <button class="scale-btn" id="scaleDown" title="Decrease scale">−</button>
                <span class="scale-value" id="scaleValue">100%</span>
                <button class="scale-btn" id="scaleUp" title="Increase scale">+</button>
            </div>
            <button class="info-btn" id="infoBtn" title="Show information">ℹ</button>
        </div>
    </div>

    <div class="editor-container">
        <div class="editor-pane">
            <div class="pane-header">Editor</div>
            <textarea 
                id="editor" 
                class="editor-textarea" 
                placeholder="Type Toki Pona text here...&#10;&#10;Example:&#10;mi pilin e ni: kama pona mute.&#10;toki pona li pona.&#10;ale li jo e tenpo."
                spellcheck="false"
            ></textarea>
        </div>
        
        <div class="resizer" id="resizer"></div>
        
        <div class="preview-pane">
            <div class="pane-header">Preview</div>
            <div class="preview-content" id="preview">
                <div class="preview-loading">Loading WASM module...</div>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="info-modal-close" id="infoModalClose">×</button>
            <h2>About Sitelen Sitelen Editor</h2>
            <p>This live editor allows you to type Toki Pona text and see it rendered in the beautiful Sitelen Sitelen style in real-time.</p>
            
            <h3>Writing Tips</h3>
            <ul>
                <li><strong>Lowercase text</strong>: All Toki Pona text is expected in lower case</li>
                <li><strong>Sentence endings</strong>: All sentences should end with <code>.</code>, <code>!</code>, <code>?</code>, or <code>#</code> (for banners). The colon <code>:</code> and <code>,</code> are also recognized as punctuation</li>
                <li><strong>Proper nouns in cartouches</strong>: Syllables appear in cartouches by writing words starting with an upper case letter: <code>jan Pona</code> vs <code>jan pona</code></li>
                <li><strong>Multiple sentences</strong>: Multiple sentences are automatically split by punctuation. Each sentence is rendered separately</li>
                <li><strong>Commas</strong>: Commas before <code>la</code> and <code>li</code> are automatically removed, so <code>tenpo, la</code> becomes <code>tenpo la</code></li>
                <li><strong>Spacing</strong>: Double spaces are automatically normalized to single spaces</li>
                <li><strong>Context separators</strong>: The <code>la</code> particle is recognized as a context separator and creates separate sentence parts</li>
            </ul>

            <h3>Controls</h3>
            <ul>
                <li><strong>Scale controls</strong>: Use the +/- buttons to adjust the column width and scale of the rendered SVGs</li>
                <li><strong>Resizer</strong>: Drag the divider between editor and preview panes to adjust their relative sizes</li>
            </ul>

            <h3>About</h3>
            <p>I created <span class="wordmark">Sitelen Sitelen Renderer</span> because I am fascinated by combining the artificial language Toki Pona with the non-linear writing style 'Sitelen Sitelen' by Jonathan Gabel. Unlike other work with Sitelen Sitelen I want the writings to be generated by the computer. My <a href="http://nullelement.org/2015/05/living-toki-pona-using-flexbox-layout-and-sitelen-sitelen/" target="_blank">first attempt</a> was in the beginning of 2015 when I experimented with CSS Flexbox using SVG for the Glyphs. The algorithm was limited and doomed so in October 2015 I started anew, and set out to create SVG-only sitelen sitelen that can be exported and reused.</p>
            <p>The project had since then been mostly dormant, with only a few minor fixes here and there. Now, in 2025 the project has accumulated so much rust, its codebase is now rewritten in Rust. This Rust rewrite maintains the same visual output and algorithm spirit while providing better performance, type safety, and modern tooling. This is still a hobby project that I work on in my spare time.</p>
            <p>Mind that this project is very much in alpha, many language constructs are not implemented yet. If you find them you can add them to the issue list, see my <a href="https://github.com/olafjanssen/sitelen-sitelen-renderer/" target="_blank">GitHub repo</a>.</p>
            <p>~ Cheers! <a href="https://nl.linkedin.com/in/otajanssen" target="_blank">Olaf Janssen</a></p>

            <h3>Attribution</h3>
            <p>This live sitelen sitelen editor is made possible by the great work done before me.</p>
            <p><a href="http://tokipona.org/" target="_blank">Toki Pona</a> is an artificial language invented in 2001 by Sonja Lang as an attempt to understand the meaning of life in 120 words.</p>
            <p><a href="http://www.jonathangabel.com/archive/2012/projects_t47.html" target="_blank">Sitelen Sitelen or Sitelen Suwi</a> is a project created by Jonathan Gabel in 2012 who created a non-linear writing style for Toki Pona inspired by Mayan script.</p>
            <p>The <a href="http://forums.tokipona.org/viewtopic.php?f=7&p=13786#p13786" target="_blank">vectorized glyphs</a> are based on the excellent work by jan Same.</p>
        </div>
    </div>

    <script type="module">
        import init, { render_sentences } from '../../sitelen-wasm/pkg/sitelen_wasm.js';

        let initialized = false;
        let renderTimeout = null;
        let currentScale = 100; // Scale percentage for column width

        // Initialize WASM
        async function ensureInit() {
            if (!initialized) {
                try {
                    await init();
                    initialized = true;
                    document.getElementById('preview').innerHTML = '<div class="preview-empty">Start typing to see the preview...</div>';
                    console.log('Sitelen Sitelen renderer initialized');
                } catch (error) {
                    document.getElementById('preview').innerHTML = 
                        `<div class="preview-error">Failed to initialize WASM module: ${error.message}</div>`;
                    console.error('Initialization error:', error);
                    throw error;
                }
            }
        }

        // Render text with debouncing
        async function renderText() {
            if (!initialized) {
                await ensureInit();
            }

            const text = document.getElementById('editor').value.trim();
            const preview = document.getElementById('preview');

            if (!text) {
                preview.innerHTML = '<div class="preview-empty">Start typing to see the preview...</div>';
                return;
            }

            try {
                const container = document.createElement('div');
                container.className = 'sentences-container';
                
                const html = render_sentences(text, null);
                if (!html || html.trim().length === 0) {
                    preview.innerHTML = '<div class="preview-empty">No valid sentences found...</div>';
                    return;
                }

                container.innerHTML = html;
                preview.innerHTML = '';
                preview.appendChild(container);
                
                // Apply current scale
                applyScale();
            } catch (error) {
                const errorMsg = error.message || String(error);
                preview.innerHTML = `<div class="preview-error">Error rendering: ${errorMsg}</div>`;
                console.error('Rendering error:', error);
            }
        }

        // Debounced render function
        function debouncedRender() {
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            renderTimeout = setTimeout(renderText, 300); // 300ms debounce
        }

        // Scale control functions
        function applyScale() {
            const container = document.querySelector('.sentences-container');
            if (container) {
                const baseWidth = 100;
                const scaledWidth = (baseWidth * currentScale) / 100;
                container.style.columnWidth = `${scaledWidth}px`;
                
                // Also scale all SVGs within the container
                const svgs = container.querySelectorAll('svg');
                svgs.forEach(svg => {
                    svg.style.width = `${scaledWidth}px`;
                });
            }
            
            document.getElementById('scaleValue').textContent = `${currentScale}%`;        
        }

        function scaleUp() {
            if (currentScale < 300) {
                currentScale = Math.min(currentScale + 10, 300);
                applyScale();
            }
        }

        function scaleDown() {
            if (currentScale > 50) {
                currentScale = Math.max(currentScale - 10, 50);
                applyScale();
            }
        }

        // Info modal functions
        function openInfoModal() {
            document.getElementById('infoModal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }

        // Resizer functionality
        let isResizing = false;
        const resizer = document.getElementById('resizer');
        const editorPane = document.querySelector('.editor-pane');
        const previewPane = document.querySelector('.preview-pane');

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('active');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const container = document.querySelector('.editor-container');
            const containerRect = container.getBoundingClientRect();
            const newLeftWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
            
            if (newLeftWidth > 10 && newLeftWidth < 90) {
                editorPane.style.flex = `0 0 ${newLeftWidth}%`;
                previewPane.style.flex = `0 0 ${100 - newLeftWidth}%`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });

        // Initialize on page load
        window.addEventListener('load', async () => {
            await ensureInit();
            
            const editor = document.getElementById('editor');
            
            // Set initial example text with multiple sentences
            editor.value = 'mi pilin e ni: kama pona mute.\ntoki pona li pona.\nale li jo e tenpo.\nsina pona.\nmi wile e ni.';
            
            // Render initial text
            renderText();
            
            // Add event listeners
            editor.addEventListener('input', debouncedRender);
            editor.addEventListener('paste', () => {
                setTimeout(debouncedRender, 100);
            });

            // Scale controls
            document.getElementById('scaleUp').addEventListener('click', scaleUp);
            document.getElementById('scaleDown').addEventListener('click', scaleDown);

            // Info modal
            document.getElementById('infoBtn').addEventListener('click', openInfoModal);
            document.getElementById('infoModalClose').addEventListener('click', closeInfoModal);
            document.getElementById('infoModal').addEventListener('click', (e) => {
                if (e.target.id === 'infoModal') {
                    closeInfoModal();
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeInfoModal();
                }
            });
        });
    </script>
</body>
</html>

